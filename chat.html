<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title></title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="chat.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chance/1.1.8/chance.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

  <script>
    /*
    * Original code by Cocahh
    * This is a refactor by me, Plaabo twitch.tv/plaabo
    */
    const CONTAINER_SELECTOR = '.main-container'
    const EVENTS = {
      ON_WIDGET_LOAD: 'onWidgetLoad',
      ON_EVENT_RECEIVED: 'onEventReceived',
    }
    const LISTENERS = {
      DELETE_MESSAGE: 'delete-message',
      DELETE_MESSAGES: 'delete-messages',
      MESSAGE: 'message',
    }
    const ADDITIONS = {
      APPEND: 'append',
      PREPEND: 'prepend',
    }

    let totalMessages = 0
    let removeSelector = null
    let addition = ADDITIONS.PREPEND
    let channelName = null
    let provider = null
    let ignoredUsers = []
    let testMessagesIntervalId = null
    let shouldHideMessagesAfterDelay = true

    // params from streamelements fields
    let animationIn = 'bounceIn'
    let animationOut = 'bounceOut'
    let hideAfter = 10
    let messagesLimit = 10
    let nickColorType = 'user'
    let customNickColor = null
    let hideCommands = 'no'
    let messagesInterval = 1.5

    function deleteMessage(messageId) {
      $(`.message-row[data-msgid=${messageId}]`).remove();
    }

    function deleteUserMessages(userId) {
      $(`.message-row[data-sender=${userId}]`).remove();
    }

    function isCommand(text) {
      return text.startsWith('!')
    }

    function getBadgesHtmlString(badges) {
      const badgeHtmlStrings = badges.map(badge => {
        return `<img alt="" src="${badge.url}" class="badge"> `
      })

      return badgeHtmlStrings.join('')
    }

    function getUsernameHtmlString(displayName, displayColor = '') {
      let username = displayName + ':'
      let color = ''

      if (nickColorType === 'user') {
        color = displayColor !== '' ? displayColor : '#' + (md5(username).substr(26))
      }

      if (nickColorType === 'custom') {
        color = customNickColor;
      }

      return `<span style="color:${color}">${username}</span>`
    }

    function handleUserMessage(eventData) {
      const {
        text,
        nick,
        badges,
        displayName,
        displayColor,
        isAction,
        userId,
        msgId,
      } = eventData
      const shouldHideCommands = isCommand(text) && hideCommands === 'yes'
      const shouldIgnoreUser = ignoredUsers.indexOf(nick) !== -1

      if (shouldHideCommands || shouldIgnoreUser) {
        return
      }

      const badgesHtmlString = getBadgesHtmlString(badges)

      const usernameHtmlString = getUsernameHtmlString(displayName, displayColor)

      const message = attachEmotes(eventData)

      addMessage(
        usernameHtmlString,
        badgesHtmlString,
        message,
        isAction,
        userId,
        msgId
      )
    }

    window.addEventListener(EVENTS.ON_EVENT_RECEIVED, function ({ detail }) {
      const { event, listener } = detail

      const isWidgetButton = event.listener === 'widget-button'

      if (isWidgetButton) {
        const TEST_MESSAGE = 'testMessage'
        const START_SENDING_MESSAGES = 'startSendingMessages'
        const STOP_SENDING_MESSAGES = 'stopSendingMessages'

        switch (event.field) {
          case TEST_MESSAGE:
            testMessage()
            break
          case START_SENDING_MESSAGES:
            testMessage()
            startSendingMessages()
            break
          case STOP_SENDING_MESSAGES:
            stopSendingMessages()
            break
        }
      }

      switch (listener) {
        case LISTENERS.DELETE_MESSAGE:
          deleteMessage(event.msgId)
          break
        case LISTENERS.DELETE_MESSAGES:
          deleteUserMessages(event.userId)
          break
        case LISTENERS.MESSAGE:
          handleUserMessage(event.data)
          break
      }
    })

    // TODO: refact
    window.addEventListener(EVENTS.ON_WIDGET_LOAD, function (obj) {
      const fieldData = obj.detail.fieldData
      animationIn = fieldData.animationIn
      animationOut = fieldData.animationOut
      hideAfter = fieldData.hideAfter
      messagesLimit = fieldData.messagesLimit
      nickColorType = fieldData.nickColor
      customNickColor = fieldData.customNickColor
      hideCommands = fieldData.hideCommands
      channelName = obj.detail.channel.username
      messagesInterval = fieldData.messagesInterval

      shouldHideMessagesAfterDelay = hideAfter !== 999

      fetch('https://api.streamelements.com/kappa/v2/channels/' + obj.detail.channel.id + '/')
        .then(response => response.json())
        .then((profile) => {
          provider = profile.provider
        })

      if (fieldData.alignMessages === "block") {
        addition = ADDITIONS.PREPEND
        removeSelector = ".message-row:nth-child(n+" + (messagesLimit + 1) + ")"
      } else {
        addition = ADDITIONS.APPEND
        removeSelector = ".message-row:nth-last-child(n+" + (messagesLimit + 1) + ")"
      }

      ignoredUsers = fieldData.ignoredUsers.toLowerCase().replace(" ", "").split(",")
    });

    function attachEmotes(message) {
      const { text, emotes } = message
      const encodedText = html_encode(message.text)

      // TODO: find out what the hell is this attachments
      // if (typeof message.attachment !== "undefined") {
      //   if (typeof message.attachment.media !== "undefined") {
      //     if (typeof message.attachment.media.image !== "undefined") {
      //       text = `${message.text}<img src="${message.attachment.media.image.src}">`;
      //     }
      //   }
      // }

      const words = encodedText.split(' ')

      const wordsAndEmote = words.reduce((acc, word) => {
        const emote = emotes.find(emote => emote.name === word)

        // TODO: find a better name for acc variable
        if (!!emote) {
          const emoteUrl = emote.urls[1]
          const emoteHtmlString = `<img class="emote" " src="${emoteUrl}"/>`
          return [...acc, emoteHtmlString]
        }

        return [...acc, word]
      }, [])

      return wordsAndEmote.join(' ')
    }

    function html_encode(e) {
      return e.replace(/[<>"^]/g, function (e) {
        return "&#" + e.charCodeAt(0) + ";";
      });
    }

    function removeElementFromDOM(jqueryElement) {
      jqueryElement
        .delay(1000)
        .queue(() => {
          jqueryElement.remove()
        })
        .dequeue()
    }

    function doAnimationOut(jqueryElement) {
      if (shouldHideMessagesAfterDelay) {
        jqueryElement
          .delay(hideAfter * 1000)
          .queue(() => {
            jqueryElement.removeClass(animationIn).addClass(animationOut)

            removeElementFromDOM(jqueryElement)
          })
      }
    }

    function appendMessageRow(messageRowElement) {
      const jqueryElement = $(messageRowElement).appendTo(CONTAINER_SELECTOR)

      doAnimationOut(jqueryElement)
    }

    function prependMessageRow(messageRowElement) {
      const jqueryElement = $(messageRowElement).prependTo(CONTAINER_SELECTOR)

      doAnimationOut(jqueryElement)
    }

    function addMessage(username, badges, message, isAction, userId, messageId) {
      totalMessages += 1
      let actionClass = ""

      // TODO: find out what is this action class stuff
      if (isAction) {
        actionClass = "action"
      }

      const messageRowElement = $.parseHTML(`
        <div data-sender="${userId}" data-msgid="${messageId}" class="message-row {animationIn} animated" id="msg-${totalMessages}">
          <div class="user-box ${actionClass}">${badges}${username}</div>
          <div class="user-message ${actionClass}">${message}</div>
        </div>
      `)

      switch (addition) {
        case 'append': appendMessageRow(messageRowElement)
          break
        case 'prepend': prependMessageRow(messageRowElement)
          break
      }

      if (totalMessages > messagesLimit) {
        removeRow()
      }
    }

    // TODO: refact
    function removeRow() {
      const rowToRemove = $(removeSelector)

      if (!rowToRemove) {
        return
      }

      const rowDontHaveAnimationOutClass = !rowToRemove.hasClass(animationOut)
      const hasAnimationOutSet = animationOut !== "none"

      if (hasAnimationOutSet || rowDontHaveAnimationOutClass) {
        if (shouldHideMessagesAfterDelay) {
          $(rowToRemove).dequeue()
        } else {
          rowToRemove.remove()
        }
      }
    }

    function testMessage() {
      const fakeChannelName = chance.name()
      const words = chance.integer({ min: 1, max: 10 })
      const fakeSentence = chance.sentence({ words })

      let emulated = new CustomEvent(EVENTS.ON_EVENT_RECEIVED, {
        detail: {
          listener: "message",
          event: {
            service: "twitch",
            data: {
              time: Date.now(),
              tags: {
                "badge-info": "",
                badges: "moderator/1,partner/1",
                color: "#5B99FF",
                "display-name": "StreamElements",
                emotes: "25:46-50",
                flags: "",
                id: "43285909-412c-4eee-b80d-89f72ba53142",
                mod: "1",
                "room-id": "85827806",
                subscriber: "0",
                "tmi-sent-ts": "1579444549265",
                turbo: "0",
                "user-id": "100135110",
                "user-type": "mod"
              },
              nick: fakeChannelName,
              userId: "100135110",
              displayName: fakeChannelName, //channelName,
              displayColor: "#5B99FF",
              badges: [{
                type: "moderator",
                version: "1",
                url: "https://static-cdn.jtvnw.net/badges/v1/3267646d-33f0-4b17-b3df-f923a41db1d0/3",
                description: "Moderator"
              }, {
                type: "partner",
                version: "1",
                url: "https://static-cdn.jtvnw.net/badges/v1/d12a2e27-16f6-41d0-ab77-b780518f00a3/3",
                description: "Verified"
              }],
              channel: fakeChannelName,
              text: fakeSentence,
              isAction: !1,
              emotes: [{
                type: "twitch",
                name: "Kappa",
                id: "25",
                gif: !1,
                urls: {
                  1: "https://static-cdn.jtvnw.net/emoticons/v1/25/1.0",
                  2: "https://static-cdn.jtvnw.net/emoticons/v1/25/1.0",
                  4: "https://static-cdn.jtvnw.net/emoticons/v1/25/3.0"
                },
                start: 46,
                end: 50
              }],
              msgId: "43285909-412c-4eee-b80d-89f72ba53142"
            },
            renderedText: 'Howdy! My name is Bill and I am here to serve <img src="https://static-cdn.jtvnw.net/emoticons/v1/25/1.0" srcset="https://static-cdn.jtvnw.net/emoticons/v1/25/1.0 1x, https://static-cdn.jtvnw.net/emoticons/v1/25/1.0 2x, https://static-cdn.jtvnw.net/emoticons/v1/25/3.0 4x" title="Kappa" class="emote">'
          }
        }
      });
      window.dispatchEvent(emulated);
    }

    function startSendingMessages() {
      console.log(`starting to send messages in a ${messagesInterval} seconds interval`)

      const intervalInMilliseconds = messagesInterval * 1000

      testMessagesIntervalId = setInterval(() => {
        testMessage()
      }, intervalInMilliseconds)
    }

    function stopSendingMessages() {
      console.log(`stopped sending messages`)
      if (!!testMessagesIntervalId) {
        clearInterval(testMessagesIntervalId)
      }
    }

    function fakeLoadWidget() {
      let customWidgetLoadEvent = new CustomEvent(EVENTS.ON_WIDGET_LOAD, {
        detail: {
          channel: {
            username: 'Plaabo',
            id: '5f85fd312fdac041aadbb69c',
          },
          fieldData: {
            animationIn: 'bounceIn',
            animationOut: 'bounceOut',
            hideAfter: 5, // 999 disable
            messagesLimit: 4,
            nickColor: 'user',
            customNickColor: 'red',
            hideCommands: 'no',
            alignMessages: 'block', // flex
            ignoredUsers: '',
            messagesInterval: 2,
          }
        }
      })

      window.dispatchEvent(customWidgetLoadEvent)
    }

  </script>
</head>

<body>
  <button onclick="testMessage()">Enviar mensagem</button>
  <button onclick="startSendingMessages()">Começar a enviar mensagens</button>
  <button onclick="stopSendingMessages()">Parar de enviar mensagens</button>
  <button onclick="fakeLoadWidget()">Disparar efeito de load falso</button>
  <div class="main-container"></div>
</body>

</html>